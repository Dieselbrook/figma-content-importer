<!DOCTYPE html>
<html>
<head>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: Inter, -apple-system, BlinkMacSystemFont, sans-serif; padding: 16px; background: #fff; color: #333; font-size: 13px; }
    h2 { font-size: 15px; font-weight: 600; margin-bottom: 12px; color: #1a1a1a; }
    .preview { background: #f5f5f5; border-radius: 6px; padding: 12px; margin-bottom: 12px; font-size: 12px; }
    .preview .stat { display: flex; justify-content: space-between; padding: 3px 0; }
    .preview .stat .label { color: #666; }
    .preview .stat .value { font-weight: 600; }
    .refresh { font-size: 11px; color: #18a0fb; cursor: pointer; text-decoration: underline; text-align: right; margin-top: 6px; }
    .refresh:hover { color: #0d8ce0; }
    button {
      width: 100%; padding: 14px; border: none; border-radius: 8px; font-size: 14px;
      font-weight: 600; cursor: pointer; transition: all 0.15s;
    }
    #import-btn { background: #18a0fb; color: #fff; margin-top: 4px; }
    #import-btn:hover { background: #0d8ce0; }
    #import-btn:disabled { background: #ccc; cursor: not-allowed; }
    .loading { text-align: center; color: #888; font-size: 12px; padding: 24px 0; }
    .success { background: #e6f9ed; color: #1a7f37; border-radius: 6px; padding: 12px; text-align: center; display: none; margin-top: 12px; }
    .error { background: #fdecea; color: #c62828; border-radius: 6px; padding: 12px; text-align: center; display: none; margin-top: 12px; }
  </style>
</head>
<body>
  <h2>Content Importer</h2>

  <div id="loading" class="loading">Fetching latest content...</div>

  <div id="preview" class="preview" style="display:none;">
    <div class="stat"><span class="label">Posts</span><span class="value" id="post-count">—</span></div>
    <div class="stat"><span class="label">Frames to create</span><span class="value" id="frame-count">—</span></div>
    <div class="stat"><span class="label">Last updated</span><span class="value" id="last-updated">—</span></div>
    <div class="refresh" id="refresh-link">Refresh</div>
  </div>

  <button id="import-btn" disabled>Import Latest Content</button>

  <div class="success" id="success"><span id="success-msg"></span></div>
  <div class="error" id="error"><span id="error-msg"></span></div>

  <script>
    const DATA_URL = 'https://raw.githubusercontent.com/Dieselbrook/figma-content-importer/main/data/latest.json';
    let jsonData = null;

    const loadingEl = document.getElementById('loading');
    const preview = document.getElementById('preview');
    const importBtn = document.getElementById('import-btn');
    const successEl = document.getElementById('success');
    const errorEl = document.getElementById('error');

    function parseDimensions(dimStr) {
      if (!dimStr) return [{ label: 'Frame', width: 1080, height: 1080 }];
      const results = [];
      const orParts = dimStr.split(/\s+or\s+/i);
      if (orParts.length > 1) {
        for (const part of orParts) {
          const m = part.match(/(\d+)\s*x\s*(\d+)\s*px/i);
          if (m) {
            const label = part.replace(/\d+\s*x\s*\d+\s*px/i, '').replace(/[()]/g, '').trim() || 'Frame';
            results.push({ label, width: parseInt(m[1]), height: parseInt(m[2]) });
          }
        }
        return results.length ? results : [{ label: 'Frame', width: 1080, height: 1080 }];
      }
      const parts = dimStr.split('|');
      for (const part of parts) {
        const m = part.match(/(\d+)\s*x\s*(\d+)\s*px/i);
        if (m) {
          const label = part.replace(/\d+\s*x\s*\d+\s*px/i, '').replace(/:/g, '').trim() || 'Frame';
          results.push({ label, width: parseInt(m[1]), height: parseInt(m[2]) });
        }
      }
      return results.length ? results : [{ label: 'Frame', width: 1080, height: 1080 }];
    }

    function countCarouselSlides(visualBrief) {
      if (!visualBrief) return 0;
      const matches = visualBrief.match(/Slide\s+\d+/gi);
      return matches ? Math.max(...matches.map(m => parseInt(m.match(/\d+/)[0]))) : 0;
    }

    function countFrames(posts) {
      let total = 0;
      for (const post of posts) {
        const dims = parseDimensions(post.Dimensions);
        const isCarousel = (post.Content_Format || '').toLowerCase().includes('carousel');
        if (isCarousel) {
          const slides = countCarouselSlides(post.Visual_Brief);
          total += Math.max(slides, 1) * dims.length;
        } else {
          total += dims.length;
        }
      }
      return total;
    }

    function fetchLatest() {
      jsonData = null;
      importBtn.disabled = true;
      successEl.style.display = 'none';
      errorEl.style.display = 'none';
      loadingEl.style.display = 'block';
      preview.style.display = 'none';

      const xhr = new XMLHttpRequest();
      xhr.open('GET', DATA_URL + '?t=' + Date.now(), true);
      xhr.onload = function () {
        loadingEl.style.display = 'none';
        if (xhr.status === 200) {
          try {
            const parsed = JSON.parse(xhr.responseText);
            let posts, metadata;
            if (Array.isArray(parsed)) {
              posts = parsed;
              metadata = {};
            } else if (parsed.posts && Array.isArray(parsed.posts)) {
              posts = parsed.posts;
              metadata = parsed.metadata || {};
            } else {
              throw new Error('Unexpected JSON format');
            }

            if (posts.length === 0) {
              errorEl.style.display = 'block';
              document.getElementById('error-msg').textContent = 'No posts found — data file is empty.';
              return;
            }

            jsonData = posts;
            document.getElementById('post-count').textContent = posts.length;
            document.getElementById('frame-count').textContent = countFrames(posts);
            document.getElementById('last-updated').textContent = metadata.updated || 'unknown';
            preview.style.display = 'block';
            importBtn.disabled = false;
          } catch (err) {
            errorEl.style.display = 'block';
            document.getElementById('error-msg').textContent = 'Invalid JSON: ' + err.message;
          }
        } else {
          errorEl.style.display = 'block';
          document.getElementById('error-msg').textContent = 'Fetch failed (HTTP ' + xhr.status + ')';
        }
      };
      xhr.onerror = function () {
        loadingEl.style.display = 'none';
        errorEl.style.display = 'block';
        document.getElementById('error-msg').textContent = 'Network error — could not reach GitHub.';
      };
      xhr.send();
    }

    document.getElementById('refresh-link').addEventListener('click', fetchLatest);

    importBtn.addEventListener('click', () => {
      if (!jsonData) return;
      importBtn.disabled = true;
      importBtn.textContent = 'Importing...';
      successEl.style.display = 'none';
      errorEl.style.display = 'none';
      parent.postMessage({ pluginMessage: { type: 'import', data: jsonData } }, '*');
    });

    window.onmessage = (event) => {
      const msg = event.data.pluginMessage;
      if (!msg) return;
      if (msg.type === 'success') {
        successEl.style.display = 'block';
        document.getElementById('success-msg').textContent = msg.message;
        importBtn.textContent = 'Import Latest Content';
        importBtn.disabled = false;
      } else if (msg.type === 'error') {
        errorEl.style.display = 'block';
        document.getElementById('error-msg').textContent = msg.message;
        importBtn.textContent = 'Import Latest Content';
        importBtn.disabled = false;
      }
    };

    // Auto-fetch on load
    fetchLatest();
  </script>
</body>
</html>
